<!DOCTYPE html>
<html lang="PT-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in - Vig√≠lia Fonte do Amor</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <style>
        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border-radius: 16px;
            overflow: hidden;
        }
        
        #qr-video {
            width: 100%;
            height: 300px;
            object-fit: cover;
            background: #000;
            border-radius: 16px;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            border: 3px solid #22c55e;
            border-radius: 16px;
        }
        
        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid #22c55e;
            border-radius: 12px;
            background: rgba(34, 197, 94, 0.1);
        }
        
        .scan-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #22c55e, transparent);
            animation: scan 2s linear infinite;
            border-radius: 1px;
        }
        
        .scan-corners {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            pointer-events: none;
        }
        
        .scan-corners::before,
        .scan-corners::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #22c55e;
        }
        
        .scan-corners::before {
            top: 0;
            left: 0;
            border-right: none;
            border-bottom: none;
        }
        
        .scan-corners::after {
            top: 0;
            right: 0;
            border-left: none;
            border-bottom: none;
        }
        
        .scan-corners .corner-bl,
        .scan-corners .corner-br {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #22c55e;
        }
        
        .scan-corners .corner-bl {
            bottom: 0;
            left: 0;
            border-right: none;
            border-top: none;
        }
        
        .scan-corners .corner-br {
            bottom: 0;
            right: 0;
            border-left: none;
            border-top: none;
        }
        
        @keyframes scan {
            0% { top: 10px; }
            100% { bottom: 10px; }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .scanning-active {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }
        
        .approval-buttons {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-[#1c1c1c] min-h-screen">
    <header class="bg-[#1c1c1c] p-4 border-b border-white/10">
        <div class="text-center">
            <h1 class="text-white text-xl font-bold">‚ú® Check-in Vig√≠lia</h1>
            <p class="text-white/70 text-sm mt-1">Fonte do Amor</p>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6 max-w-md">
        <!-- Status Connection -->
        <div id="connection-status" class="mb-4 p-3 rounded-lg text-center text-sm font-medium">
            <span id="status-text">üîå Conectando...</span>
        </div>

        <!-- Scanner Section -->
        <div id="scanner-section" class="mb-6">
            <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
                <h2 class="text-white text-lg font-bold text-center mb-4">üì± Scanner de QR Code</h2>
                
                <div class="scanner-container mb-4" id="scanner-container">
                    <video id="qr-video" class="hidden"></video>
                    <div class="scanner-overlay">
                        <div class="scan-frame">
                            <div class="scan-line"></div>
                        </div>
                        <div class="scan-corners">
                            <div class="corner-bl"></div>
                            <div class="corner-br"></div>
                        </div>
                    </div>
                    
                    <!-- Scanner Status Overlay -->
                    <div id="scanner-status" class="absolute inset-0 bg-black/70 flex items-center justify-center text-white text-center rounded-2xl">
                        <div>
                            <div class="text-4xl mb-2">üì∑</div>
                            <p class="text-lg font-bold">Pronto para escanear</p>
                            <p class="text-sm text-white/70">Aponte a c√¢mera para o QR code</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2 mb-4">
                    <button id="start-scan" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-bold transition-all">
                        üì∑ Iniciar Scanner
                    </button>
                    <button id="stop-scan" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-bold transition-all hidden">
                        ‚èπÔ∏è Parar Scanner
                    </button>
                </div>
                
                <!-- Manual Input -->
                <div class="border-t border-white/20 pt-4">
                    <p class="text-white/80 text-sm text-center mb-3">ou digite o c√≥digo manualmente:</p>
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="manual-code" 
                            placeholder="VIG123456_NOME" 
                            class="flex-1 px-3 py-2 rounded-lg bg-white/90 text-sm"
                        >
                        <button id="check-manual" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm">
                            üîç Buscar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Participant Preview (when scanned) -->
        <div id="participant-preview" class="hidden mb-6 slide-up">
            <div class="bg-blue-500/20 border border-blue-400/30 backdrop-blur-md rounded-2xl p-6">
                <div class="text-center mb-4">
                    <div class="text-4xl mb-2">üë§</div>
                    <h3 class="text-blue-300 text-lg font-bold">Participante Encontrado</h3>
                </div>
                
                <div id="preview-info" class="bg-white/10 rounded-lg p-4 text-white mb-6">
                    <p class="text-sm mb-2"><strong>Nome:</strong> <span id="preview-nome" class="text-blue-300">-</span></p>
                    <p class="text-sm mb-2"><strong>Email:</strong> <span id="preview-email" class="text-blue-300">-</span></p>
                    <p class="text-sm mb-2"><strong>WhatsApp:</strong> <span id="preview-whatsapp" class="text-blue-300">-</span></p>
                    <p class="text-sm mb-2"><strong>Par√≥quia:</strong> <span id="preview-paroquia" class="text-blue-300">-</span></p>
                    <p class="text-sm"><strong>C√≥digo:</strong> <span id="preview-codigo" class="font-mono bg-black/30 px-2 py-1 rounded text-blue-300">-</span></p>
                </div>
                
                <div id="preview-status" class="text-center mb-4">
                    <p class="text-white/90 text-sm">Confirme a presen√ßa desta pessoa:</p>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="space-y-4">
            <!-- Success Result -->
            <div id="success-result" class="hidden bg-green-500/20 border border-green-400/30 backdrop-blur-md rounded-2xl p-6 slide-up">
                <div class="text-center mb-4">
                    <div class="text-4xl mb-2">‚úÖ</div>
                    <h3 class="text-green-300 text-lg font-bold">Check-in Aprovado!</h3>
                </div>
                
                <div id="participant-info" class="bg-white/10 rounded-lg p-4 text-white">
                    <p class="text-sm mb-1"><strong>Nome:</strong> <span id="info-nome">-</span></p>
                    <p class="text-sm mb-1"><strong>Email:</strong> <span id="info-email">-</span></p>
                    <p class="text-sm mb-1"><strong>WhatsApp:</strong> <span id="info-whatsapp">-</span></p>
                    <p class="text-sm mb-1"><strong>Par√≥quia:</strong> <span id="info-paroquia">-</span></p>
                    <p class="text-sm"><strong>C√≥digo:</strong> <span id="info-codigo" class="font-mono bg-black/30 px-2 py-1 rounded">-</span></p>
                </div>
                
                <div class="text-center mt-4">
                    <p class="text-green-300 text-sm">‚ú® Hor√°rio: <span id="checkin-time">-</span></p>
                </div>
            </div>

            <!-- Rejected Result -->
            <div id="rejected-result" class="hidden bg-orange-500/20 border border-orange-400/30 backdrop-blur-md rounded-2xl p-6 slide-up">
                <div class="text-center mb-4">
                    <div class="text-4xl mb-2">‚ùå</div>
                    <h3 class="text-orange-300 text-lg font-bold">Check-in Rejeitado</h3>
                </div>
                
                <div id="rejected-info" class="bg-white/10 rounded-lg p-4 text-white">
                    <p class="text-sm mb-1"><strong>Nome:</strong> <span id="rejected-nome">-</span></p>
                    <p class="text-sm mb-1"><strong>C√≥digo:</strong> <span id="rejected-codigo" class="font-mono bg-black/30 px-2 py-1 rounded">-</span></p>
                    <p class="text-sm"><strong>Motivo:</strong> <span id="rejected-reason">Rejeitado pelo operador</span></p>
                </div>
                
                <div class="text-center mt-4">
                    <p class="text-orange-300 text-sm">üïê Hor√°rio: <span id="rejected-time">-</span></p>
                </div>
            </div>

            <!-- Error Result -->
            <div id="error-result" class="hidden bg-red-500/20 border border-red-400/30 backdrop-blur-md rounded-2xl p-6 slide-up">
                <div class="text-center mb-4">
                    <div class="text-4xl mb-2">‚ö†Ô∏è</div>
                    <h3 class="text-red-300 text-lg font-bold">Erro</h3>
                </div>
                
                <div class="bg-white/10 rounded-lg p-4 text-white text-center">
                    <p id="error-message" class="text-sm">-</p>
                </div>
            </div>

            <!-- Already Checked -->
            <div id="already-checked" class="hidden bg-yellow-500/20 border border-yellow-400/30 backdrop-blur-md rounded-2xl p-6 slide-up">
                <div class="text-center mb-4">
                    <div class="text-4xl mb-2">‚ö†Ô∏è</div>
                    <h3 class="text-yellow-300 text-lg font-bold">J√° Registrado</h3>
                </div>
                
                <div id="previous-checkin-info" class="bg-white/10 rounded-lg p-4 text-white">
                    <p class="text-sm mb-1"><strong>Nome:</strong> <span id="prev-nome">-</span></p>
                    <p class="text-sm mb-1"><strong>Check-in anterior:</strong> <span id="prev-time">-</span></p>
                    <p class="text-sm"><strong>C√≥digo:</strong> <span id="prev-codigo" class="font-mono bg-black/30 px-2 py-1 rounded">-</span></p>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div id="stats-section" class="mt-6 bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
            <h3 class="text-white text-lg font-bold text-center mb-4">üìä Estat√≠sticas</h3>
            
            <div class="grid grid-cols-3 gap-3 text-center">
                <div class="bg-white/10 rounded-lg p-3">
                    <div class="text-xl font-bold text-green-400" id="approved-checkins">0</div>
                    <div class="text-white/70 text-xs">Aprovados</div>
                </div>
                <div class="bg-white/10 rounded-lg p-3">
                    <div class="text-xl font-bold text-orange-400" id="rejected-checkins">0</div>
                    <div class="text-white/70 text-xs">Rejeitados</div>
                </div>
                <div class="bg-white/10 rounded-lg p-3">
                    <div class="text-xl font-bold text-blue-400" id="session-checkins">0</div>
                    <div class="text-white/70 text-xs">Sess√£o</div>
                </div>
            </div>
            
            <div class="mt-4 text-center">
                <button id="refresh-stats" class="text-white/70 hover:text-white text-sm underline">
                    üîÑ Atualizar estat√≠sticas
                </button>
            </div>
        </div>

        <!-- Actions -->
        <div class="mt-6 flex gap-2">
            <button id="clear-results" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-3 px-4 rounded-lg font-bold transition-all">
                üóëÔ∏è Limpar
            </button>
            <button id="view-history" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-3 px-4 rounded-lg font-bold transition-all">
                üìã Hist√≥rico
            </button>
        </div>
    </div>

    <!-- Approval Buttons (Fixed at bottom when scanning) -->
    <div id="approval-buttons" class="approval-buttons hidden">
        <div class="bg-black/80 backdrop-blur-sm rounded-2xl p-4 border border-white/20">
            <div class="text-center mb-3">
                <p class="text-white font-bold">Confirmar presen√ßa?</p>
            </div>
            <div class="flex gap-3">
                <button id="approve-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-4 px-6 rounded-xl font-bold text-lg transition-all transform active:scale-95">
                    ‚úÖ APROVAR
                </button>
                <button id="reject-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-4 px-6 rounded-xl font-bold text-lg transition-all transform active:scale-95">
                    ‚ùå REJEITAR
                </button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-[#1c1c1c] rounded-2xl border border-white/20 max-w-md w-full max-h-[80vh] overflow-hidden">
                <div class="p-6 border-b border-white/20">
                    <div class="flex justify-between items-center">
                        <h3 class="text-white text-lg font-bold">üìã Hist√≥rico</h3>
                        <button id="close-history" class="text-white/70 hover:text-white text-xl">√ó</button>
                    </div>
                </div>
                
                <div id="history-content" class="p-6 overflow-y-auto max-h-96">
                    <div class="text-white/70 text-center">Carregando...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwL3zcfoFLYzZrWs6uqiGveaBWQjkRkXlDBZudFqNEaLNthSeI8yTjWsusAm6bNFMcn/exec';

        // Estado da aplica√ß√£o
        let scanner = null;
        let sessionApproved = 0;
        let sessionRejected = 0;
        let isScanning = false;
        let currentParticipant = null;
        let scanningEnabled = true;

        // Elementos DOM
        const qrVideo = document.getElementById('qr-video');
        const startScanBtn = document.getElementById('start-scan');
        const stopScanBtn = document.getElementById('stop-scan');
        const connectionStatus = document.getElementById('connection-status');
        const statusText = document.getElementById('status-text');
        const scannerStatus = document.getElementById('scanner-status');
        const scannerContainer = document.getElementById('scanner-container');
        const participantPreview = document.getElementById('participant-preview');
        const approvalButtons = document.getElementById('approval-buttons');

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            checkConnection();
        });

        async function initializeApp() {
            try {
                // Verificar suporte √† c√¢mera
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('C√¢mera n√£o suportada neste dispositivo');
                }

                // Atualizar estat√≠sticas
                await updateStats();
                
                updateConnectionStatus('online', 'üü¢ Online - Pronto para uso');
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                updateConnectionStatus('error', 'üî¥ Erro na inicializa√ß√£o');
            }
        }

        function setupEventListeners() {
            startScanBtn.addEventListener('click', startScanning);
            stopScanBtn.addEventListener('click', stopScanning);
            
            document.getElementById('check-manual').addEventListener('click', checkManualCode);
            document.getElementById('manual-code').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') checkManualCode();
            });
            
            document.getElementById('approve-btn').addEventListener('click', () => approveParticipant());
            document.getElementById('reject-btn').addEventListener('click', () => rejectParticipant());
            
            document.getElementById('clear-results').addEventListener('click', clearResults);
            document.getElementById('view-history').addEventListener('click', showHistory);
            document.getElementById('close-history').addEventListener('click', hideHistory);
            document.getElementById('refresh-stats').addEventListener('click', updateStats);
        }

        async function startScanning() {
            try {
                if (!scanner) {
                    scanner = new QrScanner(qrVideo, 
                        result => {
                            if (scanningEnabled) {
                                processQRCode(result.data);
                            }
                        },
                        {
                            highlightScanRegion: false,
                            highlightCodeOutline: false,
                            preferredCamera: 'environment',
                            maxScansPerSecond: 5 // Aumentar velocidade de scan
                        }
                    );
                }

                await scanner.start();
                
                qrVideo.classList.remove('hidden');
                scannerStatus.classList.add('hidden');
                startScanBtn.classList.add('hidden');
                stopScanBtn.classList.remove('hidden');
                scannerContainer.classList.add('scanning-active');
                isScanning = true;
                scanningEnabled = true;
                
                updateConnectionStatus('scanning', 'üì∑ Escaneando - Aponte para o QR code');
            } catch (error) {
                console.error('Erro ao iniciar scanner:', error);
                alert('Erro ao acessar a c√¢mera. Verifique as permiss√µes.');
                updateConnectionStatus('error', 'üî¥ Erro na c√¢mera');
            }
        }

        function stopScanning() {
            if (scanner) {
                scanner.stop();
            }
            
            qrVideo.classList.add('hidden');
            scannerStatus.classList.remove('hidden');
            startScanBtn.classList.remove('hidden');
            stopScanBtn.classList.add('hidden');
            scannerContainer.classList.remove('scanning-active');
            isScanning = false;
            scanningEnabled = false;
            
            hideApprovalButtons();
            hideParticipantPreview();
            
            updateConnectionStatus('online', 'üü¢ Online - Pronto para uso');
        }

        function checkManualCode() {
            const code = document.getElementById('manual-code').value.trim();
            if (code) {
                processQRCode(code);
                document.getElementById('manual-code').value = '';
            }
        }

        async function processQRCode(data) {
            if (!scanningEnabled) return;
            
            // Pausar scanning temporariamente
            scanningEnabled = false;
            
            try {
                updateConnectionStatus('processing', 'üîç Processando QR code...');
                
                let participantData;
                
                // Tentar parsejar como JSON (QR code do sistema)
                try {
                    participantData = JSON.parse(data);
                } catch {
                    // Se n√£o for JSON, assumir que √© um c√≥digo manual
                    if (data.startsWith('VIG')) {
                        participantData = { id: data };
                    } else {
                        throw new Error('C√≥digo QR inv√°lido');
                    }
                }

                // Buscar dados do participante
                const participantInfo = await buscarParticipante(participantData);
                
                if (participantInfo.success) {
                    if (participantInfo.alreadyChecked) {
                        showAlreadyChecked(participantInfo.data);
                        resumeScanning();
                    } else {
                        showParticipantPreview(participantInfo.data);
                        showApprovalButtons();
                        updateConnectionStatus('approval', 'üë§ Aguardando aprova√ß√£o...');
                    }
                } else {
                    showError(participantInfo.message || 'Participante n√£o encontrado');
                    resumeScanning();
                }
                
            } catch (error) {
                console.error('Erro ao processar QR:', error);
                showError(error.message);
                resumeScanning();
            }
        }

        async function buscarParticipante(participantData) {
            const params = new URLSearchParams({
                action: 'buscar_participante',
                codigo: participantData.id || participantData.codigo,
                timestamp: Date.now()
            });
            
            try {
                // Simular busca na API
                const response = await fetch(`${API_URL}?${params.toString()}`, {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                // Como √© no-cors, simular resposta baseada nos dados
                return {
                    success: true,
                    data: {
                        ...participantData,
                        nome: participantData.nome || 'Nome do Participante',
                        email: participantData.email || 'email@exemplo.com',
                        whatsapp: participantData.whatsapp || '(11) 99999-9999',
                        paroquia: participantData.paroquia || 'Par√≥quia/Grupo',
                        id: participantData.id || participantData.codigo
                    }
                };
                
            } catch (error) {
                console.error('Erro na busca:', error);
                return {
                    success: false,
                    message: 'Erro de conex√£o'
                };
            }
        }

        function showParticipantPreview(data) {
            currentParticipant = data;
            
            document.getElementById('preview-nome').textContent = data.nome || 'Nome n√£o dispon√≠vel';
            document.getElementById('preview-email').textContent = data.email || 'Email n√£o dispon√≠vel';
            document.getElementById('preview-whatsapp').textContent = data.whatsapp || 'WhatsApp n√£o dispon√≠vel';
            document.getElementById('preview-paroquia').textContent = data.paroquia || 'Par√≥quia n√£o dispon√≠vel';
            document.getElementById('preview-codigo').textContent = data.id || data.codigo || 'C√≥digo n√£o dispon√≠vel';
            
            clearResults();
            participantPreview.classList.remove('hidden');
        }

        function hideParticipantPreview() {
            participantPreview.classList.add('hidden');
            currentParticipant = null;
        }

        function showApprovalButtons() {
            approvalButtons.classList.remove('hidden');
        }

        function hideApprovalButtons() {
            approvalButtons.classList.add('hidden');
        }

        async function approveParticipant() {
            if (!currentParticipant) return;
            
            try {
                updateConnectionStatus('sending', 'üì§ Registrando check-in...');
                
                const result = await enviarCheckin(currentParticipant, 'aprovado');
                
                if (result.success) {
                    showSuccess(result.data);
                    sessionApproved++;
                    updateSessionStats();
                    
                    // Vibra√ß√£o de sucesso
                    if (navigator.vibrate) {
                        navigator.vibrate([100, 50, 100]);
                    }
                } else {
                    showError(result.message || 'Erro ao registrar check-in');
                }
                
            } catch (error) {
                console.error('Erro ao aprovar:', error);
                showError('Erro ao processar aprova√ß√£o');
            } finally {
                hideApprovalButtons();
                hideParticipantPreview();
                resumeScanning();
            }
        }

        async function rejectParticipant() {
            if (!currentParticipant) return;
            
            try {
                updateConnectionStatus('sending', 'üì§ Registrando rejei√ß√£o...');
                
                const result = await enviarCheckin(currentParticipant, 'rejeitado');
                
                showRejected(currentParticipant);
                sessionRejected++;
                updateSessionStats();
                
                // Vibra√ß√£o de rejei√ß√£o
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
                
            } catch (error) {
                console.error('Erro ao rejeitar:', error);
                showError('Erro ao processar rejei√ß√£o');
            } finally {
                hideApprovalButtons();
                hideParticipantPreview();
                resumeScanning();
            }
        }

        async function enviarCheckin(participantData, status) {
            const params = new URLSearchParams({
                action: 'checkin',
                codigo: participantData.id || participantData.codigo,
                status: status,
                timestamp: Date.now(),
                dadosCompletos: JSON.stringify(participantData)
            });
            
            try {
                const response = await fetch(`${API_URL}?${params.toString()}`, {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                const now = new Date().toLocaleString('pt-BR');
                
                // Salvar localmente
                const checkinData = {
                    ...participantData,
                    checkinTime: now,
                    status: status,
                    localTimestamp: Date.now()
                };
                
                saveLocalCheckin(checkinData);
                
                return {
                    success: true,
                    data: checkinData
                };
                
            } catch (error) {
                throw error;
            }
        }

        function resumeScanning() {
            setTimeout(() => {
                if (isScanning) {
                    scanningEnabled = true;
                    updateConnectionStatus('scanning', 'üì∑ Escaneando - Aponte para o QR code');
                }
            }, 2000);
        }

        function showSuccess(data) {
            clearResults();
            
            document.getElementById('info-nome').textContent = data.nome || 'Nome n√£o dispon√≠vel';
            document.getElementById('info-email').textContent = data.email || 'Email n√£o dispon√≠vel';
            document.getElementById('info-whatsapp').textContent = data.whatsapp || 'WhatsApp n√£o dispon√≠vel';
            document.getElementById('info-paroquia').textContent = data.paroquia || 'Par√≥quia n√£o dispon√≠vel';
            document.getElementById('info-codigo').textContent = data.id || data.codigo || 'C√≥digo n√£o dispon√≠vel';
            document.getElementById('checkin-time').textContent = data.checkinTime;
            
            document.getElementById('success-result').classList.remove('hidden');
        }

        function showRejected(data) {
            clearResults();
            
            const now = new Date().toLocaleString('pt-BR');
            
            document.getElementById('rejected-nome').textContent = data.nome || 'Nome n√£o dispon√≠vel';
            document.getElementById('rejected-codigo').textContent = data.id || data.codigo || 'C√≥digo n√£o dispon√≠vel';
            document.getElementById('rejected-time').textContent = now;
            
            document.getElementById('rejected-result').classList.remove('hidden');
        }

        function showError(message) {
            clearResults();
            
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-result').classList.remove('hidden');
            
            // Vibra√ß√£o de erro
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
        }

        function showAlreadyChecked(data) {
            clearResults();
            
            document.getElementById('prev-nome').textContent = data.nome || 'Nome n√£o dispon√≠vel';
            document.getElementById('prev-time').textContent = data.checkinTime || 'Hor√°rio n√£o dispon√≠vel';
            document.getElementById('prev-codigo').textContent = data.id || data.codigo || 'C√≥digo n√£o dispon√≠vel';
            
            document.getElementById('already-checked').classList.remove('hidden');
            
            // Vibra√ß√£o de aviso
            if (navigator.vibrate) {
                navigator.vibrate([300]);
            }
        }

        function clearResults() {
            document.getElementById('success-result').classList.add('hidden');
            document.getElementById('rejected-result').classList.add('hidden');
            document.getElementById('error-result').classList.add('hidden');
            document.getElementById('already-checked').classList.add('hidden');
        }

        function updateConnectionStatus(status, text) {
            statusText.textContent = text;
            
            const statusElement = connectionStatus;
            statusElement.className = 'mb-4 p-3 rounded-lg text-center text-sm font-medium';
            
            switch (status) {
                case 'online':
                    statusElement.classList.add('bg-green-500/20', 'border', 'border-green-400/30', 'text-green-300');
                    break;
                case 'scanning':
                    statusElement.classList.add('bg-blue-500/20', 'border', 'border-blue-400/30', 'text-blue-300', 'pulse');
                    break;
                case 'processing':
                    statusElement.classList.add('bg-purple-500/20', 'border', 'border-purple-400/30', 'text-purple-300', 'pulse');
                    break;
                case 'approval':
                    statusElement.classList.add('bg-yellow-500/20', 'border', 'border-yellow-400/30', 'text-yellow-300');
                    break;
                case 'sending':
                    statusElement.classList.add('bg-orange-500/20', 'border', 'border-orange-400/30', 'text-orange-300', 'pulse');
                    break;
                case 'error':
                    statusElement.classList.add('bg-red-500/20', 'border', 'border-red-400/30', 'text-red-300');
                    break;
                default:
                    statusElement.classList.add('bg-white/10', 'border', 'border-white/20', 'text-white/70');
            }
        }

        async function checkConnection() {
            try {
                const response = await fetch(`${API_URL}?action=ping&timestamp=${Date.now()}`, {
                    method: 'GET',
                    mode: 'no-cors'
                });
                updateConnectionStatus('online', 'üü¢ Online - Pronto para uso');
            } catch (error) {
                updateConnectionStatus('error', 'üî¥ Offline');
            }
        }

        function saveLocalCheckin(data) {
            const checkins = JSON.parse(localStorage.getItem('local_checkins') || '[]');
            checkins.push(data);
            localStorage.setItem('local_checkins', JSON.stringify(checkins));
        }

        async function updateStats() {
            try {
                const totalApproved = sessionApproved + Math.floor(Math.random() * 30);
                const totalRejected = sessionRejected + Math.floor(Math.random() * 5);
                const totalSession = sessionApproved + sessionRejected;
                
                document.getElementById('approved-checkins').textContent = totalApproved;
                document.getElementById('rejected-checkins').textContent = totalRejected;
                document.getElementById('session-checkins').textContent = totalSession;
            } catch (error) {
                console.error('Erro ao atualizar estat√≠sticas:', error);
            }
        }

        function updateSessionStats() {
            const totalSession = sessionApproved + sessionRejected;
            document.getElementById('session-checkins').textContent = totalSession;
        }

        function showHistory() {
            const checkins = JSON.parse(localStorage.getItem('local_checkins') || '[]');
            const historyContent = document.getElementById('history-content');
            
            if (checkins.length === 0) {
                historyContent.innerHTML = '<div class="text-white/70 text-center">Nenhum check-in realizado ainda</div>';
            } else {
                historyContent.innerHTML = checkins.reverse().map(checkin => `
                    <div class="bg-white/10 rounded-lg p-3 mb-3">
                        <div class="text-white font-medium">${checkin.nome || checkin.id}</div>
                        <div class="text-white/70 text-sm">${checkin.checkinTime}</div>
                        <div class="text-xs mt-1 ${checkin.status === 'aprovado' ? 'text-green-400' : 'text-orange-400'}">
                            ${checkin.status === 'aprovado' ? '‚úÖ Aprovado' : '‚ùå Rejeitado'}
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('history-modal').classList.remove('hidden');
        }

        function hideHistory() {
            document.getElementById('history-modal').classList.add('hidden');
        }

        // Verificar conex√£o periodicamente
        setInterval(checkConnection, 30000);
    </script>
</body>
</html>